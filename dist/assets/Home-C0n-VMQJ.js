import{r as u,j as e,L as le}from"./index-D8Bwsa-h.js";const Y="simple_orders_v1",z="simple_prices_v1",p=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}),X=()=>Math.random().toString(36).slice(2)+Date.now().toString(36),Q=r=>new Date(r).toLocaleString(),h=(...r)=>r.filter(Boolean).join(" ");function Z({children:r,tone:l="neutral"}){const i="px-2 py-0.5 rounded-full text-xs font-semibold border",m={neutral:"bg-neutral-800 text-neutral-200 border-neutral-700",green:"bg-emerald-600/15 text-emerald-300 border-emerald-700/40 tabular-nums",red:"bg-rose-600/15 text-rose-300 border-rose-700/40 tabular-nums"};return e.jsx("span",{className:h(i,m[l]),children:r})}const de=6e4,N=.0015,U={ETH:"ETHUSDT",BTC:"BTCUSDT",SOL:"SOLUSDT",ADA:"ADAUSDT",XRP:"XRPUSDT",DOGE:"DOGEUSDT"};function ue(r){const l=[];return r.forEach(i=>{const m=U[i.toUpperCase()];m&&l.push(m)}),Array.from(new Set(l))}function O(r,l){return(r.side??"SELL")==="SELL"?(r.price-l)*r.qty:(l-r.price)*r.qty}function ee(r,l){return l>0?r.qty*l*N:0}function I(r,l){return!r.price||!Number.isFinite(l)||l<=0?null:((r.side??"SELL")==="SELL"?(r.price-l)/r.price:(l-r.price)/r.price)*100}function te(r){const l="=".repeat((4-r.length%4)%4),i=(r+l).replace(/-/g,"+").replace(/_/g,"/"),m=atob(i),o=new Uint8Array(m.length);for(let y=0;y<m.length;y++)o[y]=m.charCodeAt(y);return o}const B=`${location.origin}/.netlify/functions`,M="BABhNMjnoKd1_h6i71KfDy14Oiic5_hnGMXSaAyKxabcO7qHg_CvW-lG5yGWRvb42jud9p_Fm5q27idAS43imzk";async function pe(){if(!("serviceWorker"in navigator))return null;const r=await navigator.serviceWorker.register("/sw.js",{scope:"/"});return await navigator.serviceWorker.ready,r}async function xe(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){alert("Tu navegador no soporta Push.");return}if(M.startsWith("<")){alert("Falta VAPID_PUBLIC_KEY en el cliente.");return}try{const r=await pe();if(!r)throw new Error("No se pudo registrar el Service Worker");if(await Notification.requestPermission()!=="granted"){alert("No diste permiso de notificaciones.");return}let i=await r.pushManager.getSubscription();if(!i){const o=te(M);i=await r.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o})}const m=await fetch(`${B}/save-subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!m.ok){const o=await m.text().catch(()=>"");console.error("save-subscription FAIL",m.status,o),alert("No se pudo guardar la suscripción en el servidor.");return}console.log("SUBSCRIPTION JSON >>>",JSON.stringify(i)),alert("Notificaciones activadas ✔")}catch(r){console.error("enablePush error",r),alert("Error al activar notificaciones.")}}function be(){const[r,l]=u.useState(()=>{try{return JSON.parse(localStorage.getItem(Y)||"[]")}catch{return[]}}),[i,m]=u.useState(()=>{try{return JSON.parse(localStorage.getItem(z)||"{}")||{}}catch{return{}}}),[o,y]=u.useState({asset:"ETH",qty:1,price:100,side:"SELL"}),[P,F]=u.useState(!1),[J,se]=u.useState(null),[L,A]=u.useState(null),[re,G]=u.useState([]),w=(t,s="success")=>{const a={id:X(),msg:t,variant:s};G(n=>[...n,a]),setTimeout(()=>G(n=>n.filter(c=>c.id!==a.id)),4e3)},R=u.useRef({}),k=u.useRef({});u.useEffect(()=>{localStorage.setItem(Y,JSON.stringify(r))},[r]),u.useEffect(()=>{localStorage.setItem(z,JSON.stringify(i))},[i]),u.useEffect(()=>{(async()=>{try{if(!("serviceWorker"in navigator))return;const t=await navigator.serviceWorker.getRegistration();if(!t)return;const s=await t.pushManager.getSubscription();s&&A(s)}catch{}})()},[]),u.useEffect(()=>{fetch(`${B}/save-orders`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).catch(()=>{})},[r]);const ae=()=>{if(!o.asset||!o.qty||!o.price)return;const t={id:X(),ts:Date.now(),asset:o.asset.toUpperCase().trim(),qty:Number(o.qty),price:Number(o.price),side:o.side};l(s=>[t,...s])},ne=t=>l(s=>s.filter(a=>a.id!==t)),V=async t=>{const s=ue(t);if(!s.length)return;F(!0);const a={};Object.entries(U).forEach(([c,d])=>{a[d]=c});const n={};for(const c of s)try{const d=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${c}`);if(!d.ok)throw new Error(String(d.status));const f=await d.json(),g=Number(f?.price),b=a[c];b&&Number.isFinite(g)&&(n[b]=g)}catch(d){console.error("fetchPricesBatch error for",c,d),w(`No pude traer ${c}`,"error")}Object.keys(n).length&&(m(c=>({...c,...n})),se(Date.now())),F(!1)},ie=u.useMemo(()=>{const t=new Set;return o.asset&&t.add(o.asset.toUpperCase()),r.forEach(s=>t.add(s.asset.toUpperCase())),Array.from(t).filter(s=>U[s])},[r,o.asset]);u.useEffect(()=>{let t=null;const s=()=>Array.from(new Set([...Object.keys(i),o.asset,...r.map(c=>c.asset)])),a=()=>V(s());a(),t=setInterval(a,de);const n=()=>{document.visibilityState==="visible"&&a()};return document.addEventListener("visibilitychange",n),()=>{t&&clearInterval(t),document.removeEventListener("visibilitychange",n)}},[i,r,o.asset]),u.useEffect(()=>{r.forEach(t=>{const s=i[t.asset]||0,a=O(t,s),n=a>0?1:a<0?-1:0,c=R.current[t.id];if(c===void 0){R.current[t.id]=n,k.current[t.id]=n===1;return}c!==n&&(n===1?w(`✅ Ganancia en ${t.side??"SELL"} ${t.asset}: ${p.format(a)}`,"success"):n===-1&&w(`⚠️ Pérdida en ${t.side??"SELL"} ${t.asset}: ${p.format(Math.abs(a))}`,"error"),n!==1&&(k.current[t.id]=!1),n===1&&!k.current[t.id]&&(k.current[t.id]=!0,(async()=>{try{const d=`🟢 Ganancia en ${t.asset}`,f=`${t.side==="BUY"?"Compra":"Venta"} a ${p.format(t.price)} · P/L ahora: +${p.format(a)} · Precio: ${p.format(s)}`,g=await fetch(`${B}/send-push`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:d,body:f,subscription:L??void 0})}),b=await g.json().catch(()=>({}));(!g.ok||b&&b.ok===!1)&&(console.warn("send-push fallo",b||await g.text()),w("No pude enviar push (ver consola)","error"))}catch(d){console.error("Error enviando push",d),w("No pude enviar push (error de red)","error")}})()),R.current[t.id]=n)})},[i,r,L]);const $=u.useMemo(()=>r.reduce((t,s)=>{const a=i[s.asset]||0,c=(s.side??"SELL")==="SELL",d=s.qty*s.price;let f=0;if(c){if(a>0){const g=d/a,b=g*N;f=(g-b-s.qty)*a}}else f=s.qty*a*(1-N)-d;return t+f},0),[r,i]),T=u.useMemo(()=>{let t=0,s=0;return r.forEach(a=>{const n=i[a.asset]||0;if(!a.price||!n)return;const c=a.side??"SELL",d=a.qty*a.price;t+=d,s+=a.qty*n}),t<=0?null:(s-t)/t*100},[r,i]);u.useMemo(()=>r.reduce((t,s)=>{const a=i[s.asset]||0,n=O(s,a),c=ee(s,a);return t+(n-c)},0),[r,i]),u.useEffect(()=>{const s=$>=0?"🟢":"🔴",a=typeof T=="number"?` (${T>=0?"+":""}${T.toFixed(2)}%)`:"";document.title=`${s} Neto: ${p.format($)}${a}`},[$,T]);async function ce(){if(!L){alert("No hay suscripción push (aceptá permisos primero)");return}const t=await fetch("/.netlify/functions/send-push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:"🔔 Test directo",body:"Llega incluso con la app cerrada",url:"/",subscription:L})}),s=await t.json().catch(()=>({}));alert(`send-push → ${t.status} ${JSON.stringify(s)}`)}const x=r[0],v=x&&i[x.asset]||0,D=x?O(x,v):0,oe=x?ee(x,v):0,H=x?D-oe:0;return e.jsx("div",{className:"min-h-screen bg-neutral-950 text-neutral-100 p-4 sm:p-8",children:e.jsxs("div",{className:"w-full mx-auto grid gap-6",children:[e.jsx("div",{className:h("fixed z-50 space-y-2","inset-x-0 bottom-4 flex flex-col items-center","md:inset-auto md:bottom-4 md:right-4 md:left-auto md:items-end"),children:re.map(t=>e.jsx("div",{className:h("px-4 py-2 rounded-lg text-white shadow-lg max-w-[90%] sm:max-w-sm",t.variant==="error"?"bg-rose-600":t.variant==="info"?"bg-sky-600":"bg-emerald-600"),children:t.msg},t.id))}),e.jsx("section",{className:"md:hidden order-0 p-4 rounded-2xl border border-neutral-800 bg-neutral-900/60 backdrop-blur",children:x?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{tone:(x.side??"SELL")==="SELL"?"red":"green",children:x.side??"SELL"}),e.jsx("span",{className:"font-semibold",children:x.asset}),e.jsx("span",{className:"text-xs text-neutral-400",children:Q(x.ts)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Qty"}),e.jsx("span",{className:"tabular-nums",children:x.qty})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Entrada"}),e.jsx("span",{className:"tabular-nums",children:p.format(x.price)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Precio act."}),e.jsx("span",{className:"tabular-nums",children:v?p.format(v):"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Δ %"}),e.jsx("span",{className:h("tabular-nums font-semibold",(I(x,v)??0)>=0?"text-emerald-400":"text-rose-400"),children:(()=>{const t=I(x,v);return t==null?"—":`${t>=0?"+":""}${t.toFixed(2)}%`})()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Bruto"}),e.jsx("span",{className:h("tabular-nums font-semibold",D>=0?"text-emerald-400":"text-rose-400"),children:p.format(D)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-neutral-400",children:"Neto"}),e.jsx("span",{className:h("tabular-nums font-semibold",H>=0?"text-emerald-400":"text-rose-400"),children:p.format(H)})]})]})]}):e.jsx("div",{className:"mt-3 text-sm text-neutral-500",children:"Sin órdenes aún"})}),e.jsx("section",{className:"sticky top-0 z-40 p-3 rounded-2xl border border-neutral-800 bg-neutral-900/70 backdrop-blur supports-[backdrop-filter]:bg-neutral-900/50 order-2 md:order-none",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("select",{value:o.asset,onChange:t=>y(s=>({...s,asset:t.target.value})),className:"px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-sm",children:Object.keys(U).map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx("span",{className:"text-sm text-neutral-400",children:"Precio actual"}),e.jsx("span",{className:"text-xl font-semibold tabular-nums",children:i[o.asset]?p.format(i[o.asset]):"—"}),e.jsx("button",{onClick:()=>V(ie),disabled:P,className:h("px-3 py-2 rounded-xl text-sm",P?"opacity-50 cursor-not-allowed bg-white/10":"bg-white/10 hover:bg-white/20"),children:P?"Actualizando...":"Actualizar ahora"}),e.jsx("div",{className:"grow"}),J&&e.jsxs("span",{className:"text-sm text-neutral-400",children:["Última: ",new Date(J).toLocaleTimeString()]})]})}),e.jsxs("section",{className:"p-4 rounded-2xl border border-neutral-800 bg-neutral-900/30 grid gap-4 order-3 md:order-none",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Agregar orden"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-3",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Tipo"}),e.jsxs("div",{className:"inline-flex rounded-xl overflow-hidden border border-neutral-700",children:[e.jsx("button",{onClick:()=>y(t=>({...t,side:"SELL"})),className:h("px-3 py-2 text-sm",o.side==="SELL"?"bg-rose-600/20 text-rose-300":"bg-neutral-900 text-neutral-300"),children:"SELL"}),e.jsx("button",{onClick:()=>y(t=>({...t,side:"BUY"})),className:h("px-3 py-2 text-sm border-l border-neutral-700",o.side==="BUY"?"bg-emerald-600/20 text-emerald-300":"bg-neutral-900 text-neutral-300"),children:"BUY"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Activo"}),e.jsx("input",{type:"text",value:o.asset,onChange:t=>y(s=>({...s,asset:t.target.value.toUpperCase()})),className:"px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 w-full"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Cantidad"}),e.jsx("input",{type:"number",step:"0.000001",inputMode:"decimal",value:o.qty,onChange:t=>y(s=>({...s,qty:Number(t.target.value)})),className:"px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 w-full"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Precio USD"}),e.jsx("input",{type:"number",step:"0.01",inputMode:"decimal",value:o.price,onChange:t=>y(s=>({...s,price:Number(t.target.value)})),className:"px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 w-full"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:ae,className:"w-full px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold",children:"Añadir"})})]})]}),e.jsx("section",{className:"rounded-2xl overflow-auto border border-neutral-800 order-1 md:order-none",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-neutral-900/70 sticky top-0 backdrop-blur",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Fecha"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Tipo"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Activo"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Precio"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Total"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Fee operación (0.15%)"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Δ vs actual"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Δ % vs entrada"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Δ neto (cerrar ahora)"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Break-even USD"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"USDT sobrantes (cerrar ahora)"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"ETH objetivo (recomprando TODO ahora)"}),e.jsx("th",{})]})}),e.jsx("tbody",{className:"[&_tr:nth-child(even)]:bg-neutral-900/20",children:r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:14,className:"text-center text-neutral-500 py-6",children:"Sin órdenes aún"})}):r.map(t=>{const s=i[t.asset]||0,a=t.side??"SELL",n=a==="SELL",c=t.qty*t.price,d=O(t,s),f=I(t,s),g=f==null?"—":`${f>=0?"+":""}${f.toFixed(2)}%`;let b=0;n?s>0&&(b=c/s*N*s):b=t.qty*s*N;let E=0;if(n){if(s>0){const j=c/s,S=j*N;E=(j-S-t.qty)*s}}else E=t.qty*s*(1-N)-c;const K=n?t.price*(1-N):t.price/(1-N);let q=0;n||(q=t.qty*s*(1-N)-c);let W=null,C=null;if(n&&s>0){const j=c/s,S=j*N,_=j-S;W=_,C=_-t.qty}return e.jsxs("tr",{className:"border-t border-neutral-900/60",children:[e.jsx("td",{className:"px-3 py-2",children:Q(t.ts)}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(Z,{tone:n?"red":"green",children:a})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"font-medium",children:t.asset})}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:t.qty}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:p.format(t.price)}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:p.format(c)}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:p.format(b)}),e.jsx("td",{className:h("px-3 py-2 text-right font-semibold tabular-nums",d>=0?"text-emerald-400":"text-rose-400"),children:p.format(d)}),e.jsx("td",{className:h("px-3 py-2 text-right font-semibold tabular-nums",(f??0)>=0?"text-emerald-400":"text-rose-400"),children:g}),e.jsx("td",{className:h("px-3 py-2 text-right font-semibold tabular-nums",E>=0?"text-emerald-400":"text-rose-400"),children:p.format(E)}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:p.format(K)}),e.jsx("td",{className:h("px-3 py-2 text-right tabular-nums",q>=0?"text-emerald-300":"text-rose-300"),children:p.format(q)}),e.jsx("td",{className:"px-3 py-2 text-right tabular-nums",children:W==null?e.jsx("span",{className:"text-neutral-500",children:"—"}):e.jsxs("div",{className:"inline-flex flex-col items-end leading-tight",children:[e.jsxs("span",{children:[W.toFixed(6)," ETH"]}),e.jsxs("span",{className:h("text-xs font-semibold",(C??0)>=0?"text-emerald-400":"text-rose-400"),children:[(C??0)>=0?"+":"",C?.toFixed(6)," ETH"]})]})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsx("button",{onClick:()=>ne(t.id),className:"px-2 py-1 text-xs rounded bg-white/10 hover:bg-white/20",children:"borrar"})})]},t.id)})})]})}),e.jsxs("section",{className:"p-3 rounded-2xl border border-neutral-800 bg-neutral-900/40 grid gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Debug de notificaciones (solo vos lo ves)"}),e.jsxs("div",{className:"flex gap-2 flex-wrap text-sm align-items-center",children:[e.jsx("button",{onClick:async()=>{alert(`Permiso: ${Notification.permission}`)},className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20",children:"Ver permiso"}),e.jsx("button",{onClick:async()=>{if(!("serviceWorker"in navigator))return alert("No SW");const t=await navigator.serviceWorker.getRegistration();if(!t)return alert("SW no registrado");const s=await t.pushManager.getSubscription();if(!s)return alert("Sin suscripción");A(s),alert(`Sub OK: ${s.endpoint.slice(0,38)}...`),console.log("SUBSCRIPTION JSON >>>",JSON.stringify(s))},className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20",children:"Ver suscripción"}),e.jsx("button",{onClick:async()=>{if(!("serviceWorker"in navigator))return alert("No SW");await(await navigator.serviceWorker.ready).showNotification("🔔 Test local",{body:"SW activo ✅"})},className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20",children:"Test local (sin backend)"}),e.jsx("button",{onClick:async()=>{if(!("serviceWorker"in navigator))return alert("No SW");const t=await navigator.serviceWorker.ready,s=await t.pushManager.getSubscription();s&&await s.unsubscribe();const a=M,n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:te(a)});await fetch(`${B}/save-subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),A(n),alert("Resuscripto ✅")},className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20",children:"Re-suscribir"}),e.jsx("button",{onClick:xe,className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-sm",children:"🔔 Activar notificaciones"}),e.jsx("button",{onClick:async()=>{await ce()},className:"px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-sm",children:"Probar notificación"}),e.jsx("button",{onClick:async()=>{const s=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(!s)return alert("❌ Sin suscripción todavía");const a=JSON.stringify(s);await navigator.clipboard.writeText(a).catch(()=>{}),alert("✅ Suscripción copiada al portapapeles")},children:"Copiar suscripción"}),e.jsx(le,{to:"/analisis",className:"px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 text-white",children:"Ir a Análisis"})]})]})]})})}export{be as default,xe as enablePush};
